
name: Build and deploy Python app to Azure Web App â€“ pigeon-pool-backend

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/main_pigeon-pool-backend.yml'
  workflow_dispatch:

concurrency:
  group: deploy-backend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      ZIP_NAME: release.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create root requirements.txt
        run: echo "-r backend/requirements.txt" > requirements.txt

      - name: Zip artifact from repo root
        run: |
          zip -r ${{ env.ZIP_NAME }} backend requirements.txt \
            -x "backend/venv/**" "backend/.venv/**" "backend/__pycache__/**" "*.pyc" \
               "backend/.git/**" "backend/.github/**" "backend/.pytest_cache/**" "backend/tests/**" \
               "backend/.env.local" "backend/.env.*.local"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'pigeon-pool-backend'
          slot-name: 'Production'
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_9434C8B104FA42D698A263DF9534D244 }}
          package: ${{ env.ZIP_NAME }}
